name: Plugin Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Plugin Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          echo "üîç Validating JSON files..."
          json_files=$(find . -name "*.json" -not -path "*/node_modules/*" -not -path "*/.git/*")

          if [ -z "$json_files" ]; then
            echo "‚ö†Ô∏è  No JSON files found"
            exit 0
          fi

          failed=0
          for file in $json_files; do
            echo "Checking $file"
            if ! jq empty "$file" 2>/dev/null; then
              echo "‚ùå Invalid JSON: $file"
              failed=1
            else
              echo "‚úÖ Valid: $file"
            fi
          done

          if [ $failed -eq 1 ]; then
            echo "‚ùå JSON validation failed"
            exit 1
          fi

          echo "‚úÖ All JSON files are valid"

      - name: Validate shell scripts with shellcheck
        run: |
          echo "üîç Installing shellcheck..."
          sudo apt-get update -qq
          sudo apt-get install -y shellcheck

          echo "üîç Validating shell scripts..."
          shell_scripts=$(find . -name "*.sh" -not -path "*/node_modules/*" -not -path "*/.git/*")

          if [ -z "$shell_scripts" ]; then
            echo "‚ö†Ô∏è  No shell scripts found"
            exit 0
          fi

          failed=0
          for script in $shell_scripts; do
            echo "Checking $script"
            if ! shellcheck "$script"; then
              echo "‚ùå Shellcheck failed: $script"
              failed=1
            else
              echo "‚úÖ Valid: $script"
            fi
          done

          if [ $failed -eq 1 ]; then
            echo "‚ùå Shell script validation failed"
            exit 1
          fi

          echo "‚úÖ All shell scripts passed shellcheck"

      - name: Check markdown links
        run: |
          echo "üîç Installing markdown-link-check..."
          npm install -g markdown-link-check

          echo "üîç Checking markdown links..."
          md_files=$(find . -name "*.md" -not -path "*/node_modules/*" -not -path "*/.git/*")

          if [ -z "$md_files" ]; then
            echo "‚ö†Ô∏è  No markdown files found"
            exit 0
          fi

          failed=0
          for file in $md_files; do
            echo "Checking links in $file"
            if ! markdown-link-check "$file" --quiet 2>/dev/null; then
              echo "‚ö†Ô∏è  Some links may be broken in $file (non-blocking)"
              # Don't fail the build for link checking - just warn
            else
              echo "‚úÖ Links OK: $file"
            fi
          done

          echo "‚úÖ Markdown link check complete"

      - name: Validate plugin structure
        run: |
          echo "üîç Validating plugin directory structure..."

          # Check for required files
          required_files=(
            ".claude-plugin/plugin.json"
            "README.md"
            "LICENSE"
          )

          missing=0
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ Found: $file"
            else
              echo "‚ùå Missing: $file"
              missing=1
            fi
          done

          if [ $missing -eq 1 ]; then
            echo "‚ùå Plugin structure validation failed"
            exit 1
          fi

          echo "‚úÖ Plugin structure is valid"

      - name: Summary
        if: always()
        run: |
          echo "üìä Validation Summary"
          echo "===================="
          echo "‚úÖ Plugin validation workflow completed"
          echo ""
          echo "Validated:"
          echo "  - JSON syntax and structure"
          echo "  - Shell script quality (shellcheck)"
          echo "  - Markdown link integrity"
          echo "  - Plugin directory structure"
